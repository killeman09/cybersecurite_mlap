<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Carte Interactive ‚Äî Cybers√©curit√©</title>

  <!-- vis-network -->
  <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
  <!-- jsPDF pour export PDF -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root {
      --bg: #0f172a;
      --panel: #111827;
      --card: #1f2937;
      --accent: #2563eb;
      --text: #ffffff;
    }
    html,body { height:100%; margin:0; background:var(--bg); color:var(--text); font-family:"Segoe UI",Arial,sans-serif; }
    header {
      background:#111827; padding:14px 20px; font-size:20px; font-weight:700;
      border-bottom:1px solid rgba(255,255,255,0.03);
    }
    main { display:flex; height: calc(100vh - 56px); overflow:hidden; }
    #mynetwork { flex:2; min-width:320px; background: radial-gradient(circle at center, #16233a 0%, #0f172a 100%); border-right:1px solid rgba(255,255,255,0.04); }
    aside { flex:1; background:var(--panel); padding:18px; overflow:auto; box-sizing:border-box; }

    .card { background:var(--card); padding:14px; border-radius:10px; margin-bottom:14px; box-shadow:0 4px 18px rgba(0,0,0,0.35); }
    h3 { margin:0 0 8px 0; font-size:16px; }
    p { margin:0 0 8px 0; color: rgba(255,255,255,0.9); font-size:14px; line-height:1.4; }

    .actions { display:flex; justify-content:flex-end; gap:10px; margin-top:10px; flex-wrap:wrap; }
    .btn {
      background:var(--accent); color:white; border:none; padding:10px 14px; border-radius:8px; font-weight:700;
      cursor:pointer; transition:background .15s;
    }
    .btn:hover { background:#1d4ed8; }

    .explanation { background:#0d1117; border-left:4px solid #3b82f6; padding:10px; border-radius:6px; font-size:14px; line-height:1.4; }

    a.link { color:#3b82f6; text-decoration:underline; word-break:break-all; }

    /* Quiz popup (modal) */
    #quizPopup {
      display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7);
      align-items:center; justify-content:center; z-index:9999;
    }
    #quizBox {
      width:92%; max-width:820px; background:#0b1220; color:var(--text); border-radius:12px; padding:18px; box-shadow:0 10px 40px rgba(0,0,0,0.7);
      max-height:90vh; overflow:auto;
    }
    #quizHeader { display:flex; align-items:center; gap:12px; }
    #quizHeader h2 { margin:0; font-size:18px; }
    #closeQuiz { margin-left:auto; background:none; border:none; color:var(--text); font-size:20px; cursor:pointer; }

    .quiz-body { margin-top:12px; font-size:15px; }
    .quiz-question { margin-bottom:12px; }
    .quiz-options label { display:block; margin:6px 0; padding:8px; border-radius:8px; cursor:pointer; background:rgba(255,255,255,0.02); border:1px solid rgba(255,255,255,0.03); }
    .quiz-footer { display:flex; gap:8px; justify-content:space-between; align-items:center; margin-top:12px; flex-wrap:wrap; }
    .small-muted { color:rgba(255,255,255,0.6); font-size:13px; }

    /* result sheet styling inside modal */
    .result-sheet { margin-top:12px; background:#0d1320; padding:12px; border-radius:8px; }
    .result-item { padding:10px; border-radius:8px; margin-bottom:8px; border:1px solid rgba(255,255,255,0.03); }
    .correct { background: rgba(16,185,129,0.08); border-color: rgba(16,185,129,0.18); }
    .wrong { background: rgba(248,113,113,0.06); border-color: rgba(248,113,113,0.14); }

    @media (max-width:900px) {
      main { flex-direction:column; }
      #mynetwork { height:50vh; border-right:none; border-bottom:1px solid rgba(255,255,255,0.04); }
    }
  </style>
</head>
<body>
  <header>üß† Carte interactive ‚Äî Cybers√©curit√©</header>

  <main>
    <div id="mynetwork"></div>

    <aside>
      <div class="card" id="info-card">
        <h3>Bienvenue üëã</h3>
        <p>Clique sur une menace (rouge) ou une bonne pratique (verte) pour en savoir plus. Les liens utiles sont affich√©s lisiblement.</p>
      </div>

      <div class="card">
        <h3>Outils utiles üß∞</h3>
        <ul style="padding-left:18px; margin:6px 0 0 0;">
          <li><a class="link" href="https://www.virustotal.com" target="_blank">https://www.virustotal.com</a> ‚Äî V√©rifier un fichier</li>
          <li><a class="link" href="https://haveibeenpwned.com/" target="_blank">https://haveibeenpwned.com/</a> ‚Äî V√©rifier une fuite d'email</li>
          <li><a class="link" href="https://passwordsgenerator.net/" target="_blank">https://passwordsgenerator.net/</a> ‚Äî G√©n√©rer un mot de passe fort</li>
        </ul>
      </div>

      <div class="card">
        <h3>Actions üñ®Ô∏è</h3>
        <div class="actions">
          <button class="btn" id="downloadPdfBtn">T√©l√©charger la fiche PDF</button>
          <button class="btn" id="openQuizBtn">üéØ Tester mes connaissances</button>
        </div>
      </div>
    </aside>
  </main>

  <!-- Quiz modal -->
  <div id="quizPopup" role="dialog" aria-modal="true" aria-hidden="true">
    <div id="quizBox">
      <div id="quizHeader">
        <h2>Quiz ‚Äî Fiche corrig√©e</h2>
        <button id="closeQuiz" aria-label="fermer">‚úñ</button>
      </div>

      <div class="quiz-body" id="quizBody">
        <!-- Content injected by JS -->
      </div>

      <div class="quiz-footer" id="quizFooter" style="display:none;">
        <div class="small-muted" id="progressText"></div>
        <div style="display:flex; gap:8px;">
          <button class="btn" id="prevQBtn">Pr√©c√©dent</button>
          <button class="btn" id="nextQBtn">Suivant</button>
          <button class="btn" id="finishBtn" style="display:none;">Terminer et voir la fiche corrig√©e</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /***************
     *  Graph data
     ***************/
    const nodes = new vis.DataSet([
      // Menaces (rouges)
      { id: 1, label: "Phishing", color: "#dc2626", font:{color:"white"}, shape:"box" },
      { id: 2, label: "Malware", color: "#dc2626", font:{color:"white"}, shape:"box" },
      { id: 3, label: "Ransomware", color: "#dc2626", font:{color:"white"}, shape:"box" },
      { id: 4, label: "Spyware", color: "#dc2626", font:{color:"white"}, shape:"box" },
      { id: 5, label: "Trojan", color: "#dc2626", font:{color:"white"}, shape:"box" },
      { id: 6, label: "Ing√©nierie sociale", color: "#dc2626", font:{color:"white"}, shape:"box" },
      { id: 7, label: "Fuite de donn√©es", color: "#dc2626", font:{color:"white"}, shape:"box" },

      // Bonnes pratiques (vertes)
      { id: 8, label: "V√©rifier les liens", color: "#16a34a", font:{color:"white"}, shape:"box" },
      { id: 9, label: "Mots de passe forts", color: "#16a34a", font:{color:"white"}, shape:"box" },
      { id: 10, label: "Antivirus √† jour", color: "#16a34a", font:{color:"white"}, shape:"box" },
      { id: 11, label: "Mises √† jour", color: "#16a34a", font:{color:"white"}, shape:"box" },
      { id: 12, label: "Sauvegardes r√©guli√®res", color: "#16a34a", font:{color:"white"}, shape:"box" },
      { id: 13, label: "Authentification 2FA", color: "#16a34a", font:{color:"white"}, shape:"box" },
      { id: 14, label: "Sensibilisation s√©curit√©", color: "#16a34a", font:{color:"white"}, shape:"box" }
    ]);

    // Edges droites (smooth:false)
    const edges = new vis.DataSet([
      { from:1, to:8, color:"#60a5fa" }, // Phishing -> V√©rifier liens
      { from:1, to:9, color:"#60a5fa" }, // Phishing -> Mots de passe forts
      { from:2, to:10, color:"#f97316" }, // Malware -> Antivirus
      { from:3, to:11, color:"#facc15" }, // Ransomware -> Mises √† jour
      { from:3, to:12, color:"#facc15" }, // Ransomware -> Sauvegardes r√©guli√®res
      { from:4, to:10, color:"#22d3ee" }, // Spyware -> Antivirus
      { from:5, to:10, color:"#f43f5e" }, // Trojan -> Antivirus
      { from:6, to:14, color:"#10b981" }, // Ing. sociale -> Sensibilisation
      { from:7, to:9, color:"#3b82f6" },  // Fuite -> Mots de passe forts
      { from:7, to:13, color:"#3b82f6" }  // Fuite -> 2FA
    ]);

    const container = document.getElementById('mynetwork');
    const data = { nodes, edges };
    const options = {
      physics: false,
      edges: { smooth: false, width: 2 },
      nodes: { margin: 10, borderWidth: 1, widthConstraint: { maximum: 220 } },
      interaction: { hover: true },
      layout: { improvedLayout: false }
    };
    const network = new vis.Network(container, data, options);

    // Positions fixes align√©s gauche (menaces) / droite (pratiques)
    const positions = {
      // menaces (gauche)
      1: { x:-320, y:-220 },
      2: { x:-320, y:-120 },
      3: { x:-320, y:-20  },
      4: { x:-320, y:80  },
      5: { x:-320, y:180 },
      6: { x:-320, y:280 },
      7: { x:-320, y:380 },

      // pratiques (droite) - plac√©es face √† leur menace(s)
      8:  { x:320, y:-220 }, // face √† 1
      9:  { x:320, y:380  }, // face √† 7 (and 1 is higher but we set near 7 as requested)
      10: { x:320, y:-120 }, // face to 2 (antivirus)
      11: { x:320, y:-20  }, // face to 3
      12: { x:320, y:60   }, // close to 3 (ransomware backup)
      13: { x:320, y:460  }, // face to 7 (2FA)
      14: { x:320, y:280  }  // face to 6 (sensibilisation)
    };

    // move nodes and fix them (so user can't drag)
    for (const idStr in positions) {
      const id = parseInt(idStr,10);
      const pos = positions[id];
      network.moveNode(id, pos.x, pos.y);
      nodes.update({ id, fixed: { x: true, y: true } });
    }

    /***********************
     * Info panel content
     ***********************/
    const infos = {
      1: {
        title: "Phishing",
        text: "üé£ Phishing ‚Äî faux messages (email/SMS/appels) visant √† te faire cliquer ou divulguer des informations.",
        practices: [
          { label: "V√©rifier les liens", note: "Passe ta souris sur les liens, v√©rifie le domaine avant de cliquer.", url: "https://guardia.school/boite-a-outils/le-phishing-la-menace-n-1-en-matiere-de-cybersecurite.html" },
          { label: "Mots de passe forts", note: "Utilise des mots de passe longs et uniques (gestionnaire recommand√©).", url: "https://haveibeenpwned.com/" }
        ]
      },
      2: {
        title: "Malware",
        text: "ü¶† Malware ‚Äî logiciels malveillants qui endommagent ou espionnent ton appareil.",
        practices: [
          { label: "Antivirus √† jour", note: "Installe et mets √† jour un antivirus r√©put√©.", url: "https://www.mailinblack.com/ressources/glossaire/quest-ce-quun-malware/" }
        ]
      },
      3: {
        title: "Ransomware",
        text: "üí∞ Ransomware ‚Äî chiffrement des fichiers en vue d'une ran√ßon.",
        practices: [
          { label: "Mises √† jour", note: "Garde ton syst√®me et applications √† jour pour corriger les failles.", url: "https://www.mailinblack.com/ressources/glossaire/qu-est-ce-qu-un-spyware/" },
          { label: "Sauvegardes r√©guli√®res", note: "Sauvegarde hors-ligne ou sur cloud s√©curis√© et teste la restauration.", url: "https://www.ncsc.gov.uk/collection/backup" }
        ]
      },
      4: {
        title: "Spyware",
        text: "üëÄ Spyware ‚Äî collecte tes donn√©es et activit√©s √† ton insu.",
        practices: [
          { label: "Antivirus √† jour", note: "D√©tecte et supprime les spywares connus.", url: "https://www.mailinblack.com/ressources/glossaire/qu-est-ce-qu-un-spyware/" }
        ]
      },
      5: {
        title: "Trojan",
        text: "üê¥ Trojan ‚Äî programme apparemment l√©gitime qui cache un malware.",
        practices: [
          { label: "Antivirus √† jour", note: "Analyse et emp√™che les installations malveillantes.", url: "https://www.fortinet.com/fr/resources/cyberglossary/trojan-horse-virus" }
        ]
      },
      6: {
        title: "Ing√©nierie sociale",
        text: "üó£Ô∏è Ing√©nierie sociale ‚Äî manipulation humaine pour obtenir des acc√®s ou infos.",
        practices: [
          { label: "Sensibilisation s√©curit√©", note: "Former et sensibiliser les personnes r√©duit les risques.", url: "https://www.kaspersky.fr/resource-center/definitions/data-leakage" }
        ]
      },
      7: {
        title: "Fuite de donn√©es",
        text: "üíß Fuite de donn√©es ‚Äî informations personnelles rendues publiques suite √† un incident.",
        practices: [
          { label: "Mots de passe forts", note: "Utilise des mots de passe uniques et un gestionnaire.", url: "https://guardia.school/boite-a-outils/fuite-de-donnees-tout-ce-quil-faut-savoir.html" },
          { label: "Authentification 2FA", note: "Active la double authentification sur les services importants.", url: "https://authenticator.google.com/" }
        ]
      },

      // practice-only ids (so clicking them displays their info)
      8:  { title: "V√©rifier les liens", text: "Avant de cliquer : survole le lien, v√©rifie le domaine, insiste si l'URL est raccourcie ou suspecte.", practices: [] },
      9:  { title: "Mots de passe forts", text: "Longs, uniques, g√©n√©r√©s par un gestionnaire. Change si fuite connue.", practices: [] },
      10: { title: "Antivirus √† jour", text: "Permet de d√©tecter et bloquer les menaces connues.", practices: [] },
      11: { title: "Mises √† jour", text: "Corrigent failles et vuln√©rabilit√©s ‚Äî active les mises √† jour automatiques.", practices: [] },
      12: { title: "Sauvegardes r√©guli√®res", text: "Conserver des copies hors-ligne et tester la restauration.", practices: [] },
      13: { title: "Authentification 2FA", text: "Configurer la double authentification (SMS, app, cl√© physique) pour prot√©ger les comptes.", practices: [] },
      14: { title: "Sensibilisation s√©curit√©", text: "Former les utilisateurs aux risques, signaux d'alerte et bonnes pratiques.", practices: [] }
    };

    // Click handler to populate aside info card with readable links
    const infoCard = document.getElementById('info-card');
    network.on('click', params => {
      if (!params.nodes || params.nodes.length === 0) return;
      const id = params.nodes[0];
      const info = infos[id];
      if (!info) return;
      let html = `<h3>${info.title}</h3><div class="explanation">${info.text}</div>`;

      if (info.practices && info.practices.length) {
        html += `<div style="margin-top:10px;"><strong>Bonnes pratiques :</strong><ul style="padding-left:18px; margin:8px 0 0 0;">`;
        info.practices.forEach(p => {
          html += `<li style="margin-bottom:6px;"><b>${p.label} :</b> ${p.note} <br><a class="link" href="${p.url}" target="_blank">${p.url}</a></li>`;
        });
        html += `</ul></div>`;
      }
      infoCard.innerHTML = html;
    });

    /*************************
     *  Export PDF (lisible)
     *************************/
    document.getElementById('downloadPdfBtn').addEventListener('click', downloadPDF);

    function downloadPDF() {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF({ unit: "pt", format: "a4" });
      const marginLeft = 40;
      const pageWidth = 595; // A4 width in points ~595
      let y = 60;

      doc.setFontSize(18);
      doc.text("Fiche ‚Äî Cybers√©curit√© : Menaces et Bonnes pratiques", marginLeft, y);
      y += 28;
      doc.setFontSize(11);
      doc.setTextColor(40);

      // For each threat (1..7) print title and practices clearly, include links as plain text
      for (let tid = 1; tid <= 7; tid++) {
        const info = infos[tid];
        doc.setFont(undefined, 'bold');
        doc.text(`${info.title}`, marginLeft, y);
        y += 14;
        doc.setFont(undefined, 'normal');
        // body text
        const body = info.text.replace(/<[^>]*>/g, "");
        const bodyLines = doc.splitTextToSize(body, pageWidth - marginLeft * 2);
        doc.text(bodyLines, marginLeft, y);
        y += bodyLines.length * 12 + 6;

        if (info.practices && info.practices.length) {
          for (const p of info.practices) {
            const line = `‚Ä¢ ${p.label} ‚Äî ${p.note}`;
            const lines = doc.splitTextToSize(line, pageWidth - marginLeft * 2);
            doc.text(lines, marginLeft + 10, y);
            y += lines.length * 12;
            // show URL text on its own line (readable)
            const urlLines = doc.splitTextToSize(p.url, pageWidth - marginLeft * 2);
            doc.text(urlLines, marginLeft + 14, y);
            y += urlLines.length * 12 + 6;
          }
        }
        y += 8;
        // new page if near bottom
        if (y > 740) { doc.addPage(); y = 40; }
      }

      // Footer small note
      doc.setFontSize(9);
      doc.setTextColor(120);
      doc.text("Fiche g√©n√©r√©e depuis la carte interactive ‚Äî garde cette page pour te r√©f√©rer aux bonnes pratiques.", marginLeft, 800);
      doc.save("cybersecurite_fiche.pdf");
    }

    /*************************
     *  Quiz ‚Äî banque et UI
     *************************/
    const allQuestions = [
      { q: "Que signifie 'phishing' ?", choices: ["Un antivirus", "Une arnaque par message/email", "Un type de sauvegarde"], correct: 1, exp: "Le phishing est une tentative d'arnaque via messages pour voler des informations." },
      { q: "Que fait un ransomware ?", choices: ["Chiffre tes fichiers et demande une ran√ßon", "Efface l'antivirus", "Change le th√®me du PC"], correct: 0, exp: "Le ransomware chiffre les donn√©es et exige souvent une ran√ßon." },
      { q: "Pourquoi installer les mises √† jour ?", choices: ["Pour corriger des failles de s√©curit√©", "Pour changer l'ic√¥ne", "Pour ralentir le PC"], correct: 0, exp: "Les mises √† jour corrigent des vuln√©rabilit√©s." },
      { q: "Avant de cliquer sur un lien, que faire ?", choices: ["V√©rifier l'adresse du lien", "Cliquer imm√©diatement", "Partager le lien"], correct: 0, exp: "Toujours v√©rifier l'URL et la source." },
      { q: "Qu'est-ce qu'un mot de passe fort ?", choices: ["Court et simple", "Long avec lettres, chiffres et symboles", "Le m√™me partout"], correct: 1, exp: "Un mot de passe fort est long et mixe types de caract√®res." },
      { q: "Que fait un antivirus ?", choices: ["D√©tecte et bloque les logiciels malveillants", "Rend l'√©cran bleu", "Sauvegarde les fichiers"], correct: 0, exp: "L'antivirus identifie et bloque les menaces connues." },
      { q: "Qu'est-ce qu'un Trojan ?", choices: ["Programme d√©guis√© qui installe un malware", "Un type de sauvegarde", "Un navigateur"], correct: 0, exp: "Un Trojan se cache dans un programme apparemment l√©gitime." },
      { q: "Comment pr√©venir une fuite de donn√©es ?", choices: ["Utiliser mots de passe uniques et 2FA", "Partager mots de passe", "Ne rien faire"], correct: 0, exp: "Mots de passe uniques et 2FA r√©duisent le risque." },
      { q: "Pourquoi sauvegarder ses fichiers ?", choices: ["Pour pouvoir les restaurer apr√®s une attaque", "Pour les supprimer", "Pour les partager"], correct: 0, exp: "Les sauvegardes permettent de r√©cup√©rer les donn√©es." },
      { q: "Que veut dire 'spyware' ?", choices: ["Logiciel qui espionne ton activit√©", "Un antivirus", "Un outil de graphisme"], correct: 0, exp: "Le spyware collecte des infos sans consentement." },
      { q: "Quel est l'int√©r√™t d'un gestionnaire de mots de passe ?", choices: ["Stocker mots de passe forts et uniques", "Les partager", "Les rendre visibles"], correct: 0, exp: "Un gestionnaire stocke et g√©n√®re des mots de passe s√©curis√©s." },
      { q: "Que faire si on te demande tes identifiants par message ?", choices: ["Ne pas r√©pondre et v√©rifier la source", "R√©pondre tout de suite", "Envoyer la photo de ta carte"], correct: 0, exp: "Ne jamais communiquer d'identifiants via message non v√©rifi√©." },
      { q: "Comment reconna√Ætre un email de phishing ?", choices: ["Adresses √©tranges, fautes, demandes urgentes", "Parfaitement r√©dig√©", "Toujours envoy√© par un ami"], correct: 0, exp: "Adresse suspecte, fautes, ou demandes urgentes sont des signaux." },
      { q: "Que faire si un fichier t√©l√©charg√© semble suspect ?", choices: ["Ne pas l'ouvrir et le scanner (VirusTotal)", "L'ouvrir quand m√™me", "Le partager"], correct: 0, exp: "Scanner via un service fiable ou supprimer le fichier." },
      { q: "L'authentification 2FA sert √† :", choices: ["Ajouter une seconde v√©rification pour prot√©ger un compte", "Rendre l'ordinateur plus rapide", "Supprimer les mots de passe"], correct: 0, exp: "La 2FA ajoute un second facteur (SMS/app/cl√©) pour s√©curiser l'acc√®s." }
    ];
    // length should be 15
    // pick 6 random unique indices
    function pickRandomIndices(total, pick) {
      const arr = Array.from({length: total}, (_,i)=>i);
      for (let i = arr.length-1; i>0; i--) {
        const j = Math.floor(Math.random()*(i+1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr.slice(0,pick);
    }

    // Quiz state
    let quizIndices = [];      // indices into allQuestions
    let currentQuestion = 0;   // 0..5
    let userAnswers = {};      // { questionIdxInQuiz: chosenIndex }
    const QUIZ_SIZE = 6;

    // UI elements
    const quizPopup = document.getElementById('quizPopup');
    const quizBody = document.getElementById('quizBody');
    const quizFooter = document.getElementById('quizFooter');
    const progressText = document.getElementById('progressText');
    const prevQBtn = document.getElementById('prevQBtn');
    const nextQBtn = document.getElementById('nextQBtn');
    const finishBtn = document.getElementById('finishBtn');
    const openQuizBtn = document.getElementById('openQuizBtn');
    const closeQuizBtn = document.getElementById('closeQuiz');

    // Start quiz (choose 6 random)
    openQuizBtn.addEventListener('click', startQuiz);
    closeQuizBtn.addEventListener('click', () => { quizPopup.style.display='none'; });

    function startQuiz() {
      // reset
      quizIndices = pickRandomIndices(allQuestions.length, QUIZ_SIZE);
      currentQuestion = 0;
      userAnswers = {};
      renderQuestion();
      quizPopup.style.display = 'flex';
      quizFooter.style.display = 'flex';
      finishBtn.style.display = 'none';
      updateProgressText();
    }

    function renderQuestion() {
      const qIdx = quizIndices[currentQuestion];
      const qObj = allQuestions[qIdx];
      // Build question HTML
      let html = `<div class="quiz-question"><strong>Question ${currentQuestion+1} / ${QUIZ_SIZE}</strong></div>`;
      html += `<div style="margin-top:8px;"><div style="font-weight:700; margin-bottom:6px;">${qObj.q}</div>`;
      html += `<div class="quiz-options">`;
      qObj.choices.forEach((c, i) => {
        const checked = userAnswers[currentQuestion] === i ? 'checked' : '';
        html += `<label><input type="radio" name="opt" value="${i}" ${checked}> ${c}</label>`;
      });
      html += `</div></div>`;
      html += `<div style="margin-top:10px; color:rgba(255,255,255,0.75); font-size:13px;">Tu peux naviguer avec <strong>Pr√©c√©dent</strong> / <strong>Suivant</strong>. √Ä la fin clique sur <strong>Terminer</strong> pour voir la fiche corrig√©e.</div>`;

      quizBody.innerHTML = html;

      // buttons visibility
      prevQBtn.style.display = currentQuestion === 0 ? 'none' : 'inline-block';
      nextQBtn.style.display = currentQuestion === QUIZ_SIZE - 1 ? 'none' : 'inline-block';
      finishBtn.style.display = currentQuestion === QUIZ_SIZE - 1 ? 'inline-block' : 'none';

      // attach listeners to radio inputs
      const radios = quizBody.querySelectorAll('input[name="opt"]');
      radios.forEach(r => {
        r.addEventListener('change', (e) => {
          userAnswers[currentQuestion] = parseInt(e.target.value, 10);
        });
      });
    }

    prevQBtn.addEventListener('click', () => {
      if (currentQuestion > 0) {
        currentQuestion--;
        renderQuestion();
        updateProgressText();
      }
    });
    nextQBtn.addEventListener('click', () => {
      // ensure an answer selected before next
      if (userAnswers[currentQuestion] === undefined) {
        alert("Choisis une r√©ponse avant de passer √† la suivante.");
        return;
      }
      if (currentQuestion < QUIZ_SIZE - 1) {
        currentQuestion++;
        renderQuestion();
        updateProgressText();
      }
    });

    finishBtn.addEventListener('click', () => {
      // ensure last question answered
      if (userAnswers[currentQuestion] === undefined) {
        alert("Choisis une r√©ponse avant de terminer.");
        return;
      }
      showResults();
    });

    function updateProgressText() {
      progressText.textContent = `Question ${currentQuestion+1} / ${QUIZ_SIZE}`;
    }

    // Show the detailed "fiche corrig√©e" inside the same modal
    function showResults() {
      // compute score
      let score = 0;
      const resultsHtmlParts = [];
      for (let i = 0; i < QUIZ_SIZE; i++) {
        const qIdx = quizIndices[i];
        const qObj = allQuestions[qIdx];
        const user = userAnswers[i];
        const correct = qObj.correct;
        const isCorrect = user === correct;
        if (isCorrect) score++;
        // result item
        const classes = isCorrect ? 'result-item correct' : 'result-item wrong';
        let item = `<div class="${classes}">`;
        item += `<div style="font-weight:700; margin-bottom:6px;">${i+1}. ${qObj.q}</div>`;
        item += `<div><strong>Ta r√©ponse :</strong> ${ user===undefined ? '<em>Aucune r√©ponse</em>' : qObj.choices[user] }</div>`;
        item += `<div><strong>R√©ponse correcte :</strong> ${qObj.choices[correct]}</div>`;
        item += `<div style="margin-top:6px; font-style:italic; color:rgba(255,255,255,0.85);">${qObj.exp}</div>`;
        item += `</div>`;
        resultsHtmlParts.push(item);
      }

      // assemble final HTML
      const finalHtml = `
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div>
            <h3 style="margin:0;">R√©sultat ‚Äî ${score} / ${QUIZ_SIZE}</h3>
            <div class="small-muted" style="margin-top:6px;">${score === QUIZ_SIZE ? 'Bravo ‚Äî aucune erreur üéâ' : (score >= Math.ceil(QUIZ_SIZE*0.7) ? 'Bon score ‚Äî quelques points √† revoir.' : 'Continue √† t‚Äôentra√Æner ‚Äî consulte la fiche corrig√©e.') }</div>
          </div>
          <div style="display:flex; gap:8px;">
            <button class="btn" id="retakeBtn">Rejouer</button>
            <button class="btn" id="printResultsBtn">Imprimer la fiche corrig√©e</button>
            <button class="btn" id="closeResultsBtn">Fermer</button>
          </div>
        </div>

        <div class="result-sheet" id="resultSheet">
          ${resultsHtmlParts.join('')}
        </div>
      `;
      quizBody.innerHTML = finalHtml;
      quizFooter.style.display = 'none';

      // attach actions
      document.getElementById('retakeBtn').addEventListener('click', () => {
        startQuiz();
      });
      document.getElementById('closeResultsBtn').addEventListener('click', () => {
        quizPopup.style.display = 'none';
      });
      document.getElementById('printResultsBtn').addEventListener('click', () => {
        // open a print window with the results content
        const resultHTML = document.getElementById('resultSheet').outerHTML;
        const title = `<h2>Fiche corrig√©e ‚Äî Quiz Cybers√©curit√© (${score}/${QUIZ_SIZE})</h2>`;
        const w = window.open('', '_blank');
        w.document.write('<html><head><title>Fiche corrig√©e</title><style>body{font-family:Arial,Helvetica,sans-serif;color:#111;background:#fff;padding:20px} .result-item{border:1px solid #ddd;padding:10px;border-radius:6px;margin-bottom:8px} .correct{background:#f0fff4} .wrong{background:#fff5f5} </style></head><body>');
        w.document.write(title + resultHTML);
        w.document.write('</body></html>');
        w.document.close();
        w.focus();
        // allow popup to render then print
        setTimeout(()=>{ w.print(); }, 300);
      });
    }

    // Accessibility: close popup on Escape
    window.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') {
        if (quizPopup.style.display === 'flex') quizPopup.style.display = 'none';
      }
    });

    // Ensure the canvas resizes properly when container changes
    window.addEventListener('resize', () => network.redraw());

  </script>
</body>
</html>